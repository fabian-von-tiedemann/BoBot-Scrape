---
phase: 16-frontmatter-upgrade
plan: 01
type: execute
depends_on: []
files_modified: [convert.py, src/ai/gemini.py]
---

<objective>
Upgrade frontmatter schema to use category/subcategory naming and add AI-extracted updated_date.

Purpose: Align frontmatter with v2.3 schema - consistent hierarchy naming and automatic date extraction.
Output: Updated convert.py with new frontmatter fields, updated AI prompt extracting updated_date.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase (provides CSV with category/subcategory columns):
@.planning/phases/15-scraper-hierarchy/15-01-SUMMARY.md

# Key files:
@convert.py
@src/ai/gemini.py

**Tech stack available:** Python, Pydantic, Gemini API
**Established patterns:** CSV DictReader lookup, YAML frontmatter generation, Pydantic response schema
**Constraining decisions:**
- Phase 15: CSV columns renamed to category/subcategory (convert.py still reads verksamhet/rutin)
- Phase 12: Always include fields in frontmatter (empty string if not available)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update converter to use category/subcategory schema</name>
  <files>convert.py</files>
  <action>
Update load_document_metadata():
- Change DictReader field access from row['verksamhet'] to row['category']
- Change row['rutin'] to row['subcategory']
- Update docstring to reflect category/subcategory naming
- Update dict keys from "verksamhet"/"rutin" to "category"/"subcategory"

Update create_frontmatter():
- Rename parameter verksamhet to category
- Rename parameter rutin to subcategory
- Change frontmatter field names from verksamhet/rutin to category/subcategory

Update process_file():
- Change doc_metadata.get("verksamhet") to doc_metadata.get("category")
- Change doc_metadata.get("rutin") to doc_metadata.get("subcategory")
- Update variable names to match new schema
  </action>
  <verify>python -c "from convert import load_document_metadata; print(load_document_metadata('downloads/documents.csv')['Bemanningsenheten/Bemanningspolicy.pdf'])" shows category/subcategory keys</verify>
  <done>convert.py reads category/subcategory from CSV, frontmatter uses category/subcategory field names</done>
</task>

<task type="auto">
  <name>Task 2: Add updated_date to AI metadata extraction</name>
  <files>src/ai/gemini.py, convert.py</files>
  <action>
In src/ai/gemini.py:
- Add updated_date field to DocumentMetadata Pydantic model (str, optional with default "")
- Update AI prompt to extract updated_date:
  "- updated_date: The document's update/revision date in YYYY-MM-DD format (look for 'Uppdaterad', 'Senast Ã¤ndrad', 'Reviderad', etc.), or empty string if not found"

In convert.py create_frontmatter():
- Add updated_date parameter (default empty string)
- Add frontmatter line for updated_date after subcategory
- Place before AI metadata block

In convert.py process_file():
- Extract updated_date from metadata if available (metadata.updated_date if metadata else "")
- Pass updated_date to create_frontmatter()
  </action>
  <verify>python -c "from src.ai import DocumentMetadata; print(DocumentMetadata.model_fields.keys())" includes updated_date</verify>
  <done>DocumentMetadata includes updated_date field, frontmatter generation includes updated_date, AI prompt requests date extraction</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "import convert"` succeeds (no import errors)
- [ ] `python -c "from src.ai import DocumentMetadata; print(DocumentMetadata.model_fields)"` shows updated_date
- [ ] Running `python convert.py --skip-ai --force` on one file produces frontmatter with category/subcategory/updated_date
</verification>

<success_criteria>

- CSV reading uses category/subcategory column names
- Frontmatter fields renamed from verksamhet/rutin to category/subcategory
- updated_date field added to DocumentMetadata and frontmatter
- AI prompt updated to extract document dates
- No Python import errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-frontmatter-upgrade/16-01-SUMMARY.md`:

# Phase 16 Plan 01: Frontmatter Schema Upgrade Summary

**[One-liner describing what shipped]**

## Performance

- **Duration:** X min
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- [Key outcomes]

## Task Commits

1. **Task 1: Update CSV/frontmatter schema** - `hash` (type)
2. **Task 2: Add updated_date extraction** - `hash` (type)

## Files Created/Modified

- `convert.py` - Description
- `src/ai/gemini.py` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

Ready for Phase 17: Batch Re-convert all documents with new frontmatter schema.

---
*Phase: 16-frontmatter-upgrade*
*Completed: YYYY-MM-DD*
</output>
