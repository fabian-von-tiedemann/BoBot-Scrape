---
phase: 09-output-quality
plan: 01
type: execute
depends_on: []
files_modified: [convert.py]
---

<objective>
Fix URL-encoded filenames, add source_url to frontmatter from documents.csv.

Purpose: Make output files readable with proper Swedish characters, and include source URL for agent referencing.
Output: convert.py that produces human-readable filenames/titles and includes source_url in frontmatter.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@convert.py
@downloads/documents.csv

**Problem 1:** Downloaded files have URL-encoded names. convert.py preserves these, resulting in:
- Filenames like `%C3%85terkallelse%20av%20matl%C3%A5dor%20rutin-hemtj%C3%A4nsten.md`
- Frontmatter titles like `title: "%C3%85terkallelse%20av%20matl%C3%A5dor%20rutin-hemtj%C3%A4nsten"`

**Problem 2:** No source_url in frontmatter - agent can't link back to original document.

**Solution:**
1. Use `urllib.parse.unquote()` to decode filenames
2. Load documents.csv and lookup URL by category+filename

**CSV structure:** `category,filename,filename_decoded,type,url`
- Key: `{category}/{filename}` matches `source_file` path
- Value: `url` column for source_url
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add URL decoding and source_url lookup</name>
  <files>convert.py</files>
  <action>
    1. Add imports at top:
       ```python
       import csv
       from urllib.parse import unquote
       ```

    2. Add function to load URL lookup from CSV:
       ```python
       def load_url_lookup(csv_path: Path) -> dict[str, str]:
           """Load category/filename -> URL mapping from documents.csv."""
           lookup = {}
           if not csv_path.exists():
               return lookup
           with open(csv_path, encoding="utf-8") as f:
               reader = csv.DictReader(f)
               for row in reader:
                   key = f"{row['category']}/{row['filename']}"
                   lookup[key] = row['url']
           return lookup
       ```

    3. In `main()`, load lookup before processing:
       ```python
       url_lookup = load_url_lookup(input_dir / "documents.csv")
       ```

    4. Pass url_lookup to process_file and update signature

    5. In `process_file()`:
       - Decode filename: `filename = unquote(input_path.stem)`
       - Lookup source_url: `source_url = url_lookup.get(source_path, "")`
       - Pass source_url to create_frontmatter

    6. In `create_frontmatter()`:
       - Add `source_url` parameter
       - Add `source_url` to frontmatter if present:
         ```python
         if source_url:
             lines.append(f'source_url: "{source_url}"')
         ```

    7. In `main()`, decode output filename:
       ```python
       decoded_stem = unquote(relative_path.stem)
       output_path = output_dir / relative_path.parent / f"{decoded_stem}.md"
       ```

    **What to avoid:** Don't decode source_file path - keep it matching actual disk path for traceability.
  </action>
  <verify>python -c "import convert" succeeds (no import errors)</verify>
  <done>convert.py updated with URL decoding and source_url lookup</done>
</task>

<task type="auto">
  <name>Task 2: Verify on sample files</name>
  <files>-</files>
  <action>
    1. Run convert.py on subset: `python convert.py --input downloads/ --output test-converted/ --skip-ai --force` (use Ctrl+C after ~10 files)
    2. List output files in one category: `ls test-converted/Bemanningsenheten/`
    3. Check frontmatter includes source_url: `head -10 "test-converted/Bemanningsenheten/Bemanningspolicy.md"`
    4. Verify title is decoded Swedish
    5. Clean up: `rm -rf test-converted/`
  </action>
  <verify>Frontmatter shows `source_url: "https://botwebb.botkyrka.se/..."` and title is readable Swedish</verify>
  <done>Sample conversion produces decoded filenames, titles, and includes source_url</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python convert.py --help` works (no import errors)
- [ ] Test conversion produces decoded filenames
- [ ] Frontmatter title is human-readable Swedish
- [ ] Frontmatter includes source_url from CSV
- [ ] source_file path unchanged (still matches disk)
</verification>

<success_criteria>

- URL-encoded filenames decoded to readable Swedish
- Frontmatter title field shows readable text
- Frontmatter includes source_url for agent referencing
- source_file path unchanged (still matches disk)
- No import errors or regressions
</success_criteria>

<output>
After completion, create `.planning/phases/09-output-quality/09-01-SUMMARY.md`
</output>
