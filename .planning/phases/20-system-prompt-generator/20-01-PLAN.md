---
phase: 20-system-prompt-generator
plan: 01
type: execute
depends_on: []
files_modified: [src/prompt_generator.py, generate_prompts.py]
---

<objective>
Generera enhet-specifika systemprompts med Gemini baserat på index-dokumenten.

Purpose: Skapa skräddarsydda systemprompts per verksamhet som ger AI-assistenten kontextuell kunskap om rutiner, topics och dokumenttyper för varje enhet.
Output: `src/prompt_generator.py` modul + `generate_prompts.py` CLI + systemprompt-filer i `prompts/` mappen.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-frontmatter-indexer/19-01-SUMMARY.md

**Tech stack available:** Python 3.11, google-genai, pydantic, argparse
**Established patterns:** Gemini structured output via Pydantic, CLI med argparse, modul i src/

**Key files:**
@src/ai/gemini.py - Existing Gemini integration pattern
@src/indexer.py - Index file structure and FolderIndex dataclass
@indexes/Hemtjänst-INDEX.md - Example index file structure

**Input data structure:**
Index files contain per-verksamhet:
- Document count
- Document types (rutin, instruktion, blankett, etc.)
- Subcategories (rutinområden)
- Topics (tematiska ämnen)
- Keywords (sökord)
- Document list with summaries

**System prompt requirements:**
- Ska vara på svenska
- Inkludera verksamhetens namn och syfte
- Lista relevanta rutinkategorier
- Nämna dokumenttyper som finns
- Ge AI-assistenten kontext för att svara på frågor om enheten
- Max ~1500 tokens per prompt (Gemini context budget)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prompt generator module</name>
  <files>src/prompt_generator.py</files>
  <action>
Create `src/prompt_generator.py` with:

1. `SystemPrompt` Pydantic model:
   - `verksamhet: str` - enhetens namn
   - `introduction: str` - 2-3 meningar om enhetens uppdrag
   - `key_areas: list[str]` - 5-8 huvudområden baserat på subcategories/topics
   - `document_types_summary: str` - vilka typer av dokument som finns
   - `guidance: str` - hur AI:n ska använda kunskapen

2. `generate_system_prompt(index_content: str) -> SystemPrompt`:
   - Tar index-fil innehåll som input
   - Använder befintlig Gemini-mönster från src/ai/gemini.py
   - Genererar strukturerad systemprompt
   - Returnerar SystemPrompt eller None vid fel

3. `format_prompt(prompt: SystemPrompt) -> str`:
   - Formaterar SystemPrompt till markdown-sträng
   - Läsbar format för användning i AI-assistenter

4. `read_index_file(path: Path) -> str`:
   - Läser index-fil och returnerar innehåll
   - Hanterar encoding (utf-8)

**Gemini prompt för generering:**
"Du är expert på att skapa systemprompts för AI-assistenter inom svensk kommunal verksamhet. Baserat på detta index-dokument, skapa en systemprompt för en AI-assistent som ska hjälpa anställda inom denna verksamhet."

**Undvik:** Hårdkodade verksamhetsnamn - allt ska genereras dynamiskt från index-innehållet.
  </action>
  <verify>python -c "from src.prompt_generator import *; print('Import OK')"</verify>
  <done>Module imports successfully, SystemPrompt model defined, generate_system_prompt function exists</done>
</task>

<task type="auto">
  <name>Task 2: Create prompt generator CLI</name>
  <files>generate_prompts.py</files>
  <action>
Create `generate_prompts.py` CLI with argparse:

1. Arguments:
   - `--input PATH` - Input directory med index-filer (default: `./indexes`)
   - `--output PATH` - Output directory för prompts (default: `./prompts`)
   - `--verbose` - Visa detaljerad output

2. Main flow:
   - Hitta alla `*-INDEX.md` filer i input-mappen
   - För varje index-fil:
     - Läs innehåll
     - Generera systemprompt via `generate_system_prompt()`
     - Formatera och skriv till `{verksamhet}-PROMPT.md`
   - Progress output: "Processing {name}... done"
   - Summary: "Generated N prompts in {output_dir}"

3. Error handling:
   - Graceful degradation om Gemini misslyckas (skip, fortsätt)
   - Warning för tomma/ogiltiga index-filer

**Output filformat:**
```markdown
# Systemprompt: {verksamhet}

## Introduktion
{introduction}

## Huvudområden
- {key_area_1}
- {key_area_2}
...

## Dokumenttyper
{document_types_summary}

## Vägledning
{guidance}
```
  </action>
  <verify>python generate_prompts.py --input indexes --output prompts --verbose</verify>
  <done>CLI runs successfully, creates prompts/ directory with 15 prompt files (one per verksamhet)</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "from src.prompt_generator import *"` imports successfully
- [ ] `python generate_prompts.py --input indexes --output prompts` runs without errors
- [ ] `ls prompts/` shows 15 `*-PROMPT.md` files (one per verksamhet)
- [ ] Sample prompt file contains introduction, key_areas, document_types_summary, guidance
- [ ] Prompts are in Swedish
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- 15 system prompts generated in prompts/ directory
- Each prompt contains verksamhet-specific context
- No errors or warnings introduced
</success_criteria>

<output>
After completion, create `.planning/phases/20-system-prompt-generator/20-01-SUMMARY.md`:

# Phase 20-01: System Prompt Generator Summary

**[Substantive one-liner]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `src/prompt_generator.py` - Description
- `generate_prompts.py` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Step

Ready for Phase 21: General Prompt Template
</output>
