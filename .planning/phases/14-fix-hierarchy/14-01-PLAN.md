---
phase: 14-fix-hierarchy
plan: 01
type: execute
depends_on: []
files_modified: [scrape.py, downloads/documents.csv]
---

<objective>
Fix the verksamhet/rutin hierarchy by scraping subcategory headings from category pages.

Purpose: Currently the hierarchy is inverted - what we call "verksamhet" should be the category (Hemtjänst, Boendestöd), and "rutin" should be the subcategory heading each document falls under.

Output: Updated scrape.py that captures subcategory context, regenerated CSV with correct hierarchy.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-rutin-scraper-update/11-01-SUMMARY.md
@.planning/phases/12-frontmatter-properties/12-01-SUMMARY.md
@scrape.py
@convert.py

**Problem (from git commit cc07db2):**
- Current: verksamhet="Vård- och omsorgsförvaltningen", rutin="Bemanningsenheten"
- Expected: verksamhet="Bemanningsenheten", rutin="Frånvaro för timvikarier"

**Hierarchy fix:**
- Remove VERKSAMHET constant (no longer needed)
- Rename `category` → `verksamhet` in CSV
- Add new `rutin` column with subcategory heading extracted from HTML

**HTML structure hypothesis:**
Category pages likely have section headings (h2/h3 tags or div.section) that group related documents.
Documents under each heading belong to that "rutin" subcategory.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate HTML structure and update scrape.py</name>
  <files>scrape.py</files>
  <action>
1. Navigate to a category page and inspect the HTML structure to find how documents are grouped under headings
2. Update the document extraction loop to capture the nearest preceding heading as `rutin`
3. Remove the VERKSAMHET constant - it will be replaced by category name
4. Update CSV schema: rename column order to `verksamhet, rutin, filename, filename_decoded, type, url`
   - verksamhet = category name (former "category")
   - rutin = subcategory heading (new - extracted from HTML)
5. Handle cases where documents have no preceding heading (use "Övriga" or empty string)

Expected HTML patterns to look for:
- h2/h3 headings followed by lists of document links
- div with class like "section" or "accordion"
- Anchor tags with preceding heading siblings

When scraping each category page:
- First, find all heading elements (h2, h3, or similar structural elements)
- For each document link, determine which heading it falls under by:
  a) Finding the nearest preceding heading in DOM order, OR
  b) Finding the parent container and its associated heading

Update write_to_csv to use new column names (verksamhet instead of category, add rutin).
  </action>
  <verify>
1. Run with --scan-only on a test category: `.venv/bin/python scrape.py --scan-only`
2. Inspect documents.csv first 30 lines to verify:
   - verksamhet column has category names (Bemanningsenheten, Hemtjänst, etc.)
   - rutin column has subcategory headings (not empty for most documents)
   - Old "Vård- och omsorgsförvaltningen" value no longer appears
  </verify>
  <done>
- scrape.py extracts subcategory headings from category pages
- CSV has correct columns: verksamhet, rutin, filename, filename_decoded, type, url
- documents.csv regenerated with new schema (~1195 documents)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Updated scrape.py with subcategory extraction and new CSV schema</what-built>
  <how-to-verify>
    1. Review the first 50 lines of downloads/documents.csv
    2. Check that verksamhet contains category names like "Bemanningsenheten", "Hemtjänst"
    3. Check that rutin contains subcategory headings (should vary within each verksamhet)
    4. If rutin is empty or all same value for a verksamhet, the HTML structure analysis may need adjustment
    5. Optional: Compare a few documents to the actual intranet page to verify correct rutin assignment
  </how-to-verify>
  <resume-signal>Type "approved" if hierarchy looks correct, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] scrape.py runs without errors
- [ ] documents.csv has new column schema (verksamhet, rutin, ...)
- [ ] verksamhet values are category names (not "Vård- och omsorgsförvaltningen")
- [ ] rutin values vary within each verksamhet (subcategory headings)
- [ ] No syntax errors or import issues
</verification>

<success_criteria>

- scrape.py updated with subcategory extraction logic
- VERKSAMHET constant removed
- CSV schema changed: category → verksamhet, new rutin column added
- documents.csv regenerated with correct hierarchy
- Human verified the hierarchy mapping is correct
</success_criteria>

<output>
After completion, create `.planning/phases/14-fix-hierarchy/14-01-SUMMARY.md`:

# Phase 14 Plan 01: Scraper Update Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [What was changed in scrape.py]
- [How subcategory extraction works]
- [CSV schema changes]

## Files Created/Modified

- `scrape.py` - [description]
- `downloads/documents.csv` - [description]

## Decisions Made

- [How subcategories were identified in HTML]
- [Handling of documents without clear subcategory]

## Issues Encountered

[Any issues and resolutions]

## Next Step

Ready for 14-02-PLAN.md: Update convert.py to use new CSV schema and re-convert all documents.
</output>
