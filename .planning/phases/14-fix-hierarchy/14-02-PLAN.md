---
phase: 14-fix-hierarchy
plan: 02
type: execute
depends_on: ["14-01"]
files_modified: [convert.py, converted/**/*.md]
---

<objective>
Update convert.py to use the corrected verksamhet/rutin hierarchy and re-convert all documents.

Purpose: Apply the fixed hierarchy from 14-01 to the markdown conversion pipeline so all documents have correct verksamhet (category) and rutin (subcategory) frontmatter.

Output: All ~1143 markdown files updated with correct hierarchy in frontmatter.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-fix-hierarchy/14-01-SUMMARY.md
@convert.py
@downloads/documents.csv

**From 14-01:**
- CSV now has: verksamhet (category name), rutin (subcategory heading)
- Old VERKSAMHET constant removed from scrape.py
- documents.csv regenerated with new schema

**Required changes to convert.py:**
- Update load_document_metadata() to read new column names
- verksamhet now comes from CSV verksamhet column (was mapped from constant)
- rutin now comes from CSV rutin column (was mapped from category)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update convert.py metadata lookup</name>
  <files>convert.py</files>
  <action>
Update load_document_metadata() function:
- Change the mapping to read directly from CSV columns:
  - verksamhet: row['verksamhet'] (the category name)
  - rutin: row['rutin'] (the subcategory heading)
- The lookup key remains category/filename for backwards compatibility with file paths
- Note: The file path still uses the original category folder name, so key construction stays the same

Change from (current):
```python
lookup[key] = {
    "url": row['url'],
    "verksamhet": row['verksamhet'],
    "rutin": row['category']
}
```

To (new):
```python
lookup[key] = {
    "url": row['url'],
    "verksamhet": row['verksamhet'],
    "rutin": row['rutin']
}
```

This is a minimal change - the CSV columns are already named correctly from 14-01.
  </action>
  <verify>Run `python -c "from convert import load_document_metadata; from pathlib import Path; d = load_document_metadata(Path('downloads/documents.csv')); print(list(d.items())[:2])"` to verify metadata loads with new rutin values</verify>
  <done>convert.py reads verksamhet and rutin directly from CSV columns</done>
</task>

<task type="auto">
  <name>Task 2: Re-convert all documents with fixed hierarchy</name>
  <files>converted/**/*.md</files>
  <action>
1. Clear existing converted files: `rm -rf converted/*`
2. Run conversion: `.venv/bin/python convert.py --force --skip-ai`
3. Verify output count matches expected (~1143 files)
4. Spot-check a few files to verify frontmatter has correct verksamhet/rutin values
  </action>
  <verify>
- Count files: `find converted -name "*.md" | wc -l` should show ~1143
- Check frontmatter: `head -10 converted/Hemtjänst/*.md | head -30` should show verksamhet="Hemtjänst" and rutin with subcategory value
  </verify>
  <done>All markdown files have correct verksamhet (category name) and rutin (subcategory heading) in frontmatter</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] convert.py loads metadata correctly from new CSV schema
- [ ] All ~1143 markdown files re-converted
- [ ] Frontmatter shows verksamhet with category name (e.g., "Hemtjänst")
- [ ] Frontmatter shows rutin with subcategory heading (varies within each category)
- [ ] No conversion errors beyond expected failures (~4 problematic source files)
</verification>

<success_criteria>

- convert.py updated to read new CSV column mapping
- All documents re-converted with correct frontmatter hierarchy
- Phase 14 complete
- v2.2 Frontmatter Enrichment milestone fully complete
</success_criteria>

<output>
After completion, create `.planning/phases/14-fix-hierarchy/14-02-SUMMARY.md`:

# Phase 14 Plan 02: Conversion Update Summary

**[One-liner - all documents updated with correct verksamhet/rutin hierarchy]**

## Accomplishments

- Updated convert.py metadata lookup for new CSV schema
- Re-converted all ~1143 documents with fixed frontmatter

## Files Created/Modified

- `convert.py` - Updated load_document_metadata() mapping
- `converted/**/*.md` - All files re-generated

## Decisions Made

[Any decisions made during execution]

## Issues Encountered

[Any issues and resolutions]

## Next Phase Readiness

- Phase 14 complete
- v2.2 Frontmatter Enrichment milestone complete
- All documents now have correct hierarchy: verksamhet (category) and rutin (subcategory)
</output>
