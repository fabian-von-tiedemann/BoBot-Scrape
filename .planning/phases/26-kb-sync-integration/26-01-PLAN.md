---
phase: 26-kb-sync-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [pipeline.py]
autonomous: true
---

<objective>
Add automatic GitHub sync to pipeline.py with --push-kb flag.

Purpose: After pipeline completes, optionally sync converted/, indexes/, and prompts/ to bobot-kb GitHub repository.
Output: Working --push-kb flag that syncs pipeline outputs to GitHub.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-incremental-updates/25-01-SUMMARY.md

@pipeline.py
@.claude/commands/digi/push-kb.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --push-kb flag and sync_to_kb() function</name>
  <files>pipeline.py</files>
  <action>
Add to pipeline.py:

1. Add --push-kb argument to parse_args():
   ```python
   parser.add_argument(
       "--push-kb",
       action="store_true",
       help="Push KB content to bobot-kb GitHub repo after pipeline completes"
   )
   ```

2. Create sync_to_kb() function that:
   - Creates/updates temp clone at /tmp/bobot-kb-sync
   - Uses standard git (not gh CLI since it may not be installed)
   - Clones https://github.com/fabian-von-tiedemann/bobot-kb.git if not exists
   - Fetches and resets if exists
   - Rsyncs three directories with --delete:
     - converted/ → temp/converted/
     - indexes/ → temp/indexes/
     - prompts/ → temp/prompts/
   - Uses run directory sources if they exist, else root directory
   - Commits with timestamp message "sync: KB update YYYY-MM-DD HH:MM:SS UTC"
   - Pushes to main branch
   - Returns (success: bool, message: str)

3. Call sync_to_kb() at end of main() if --push-kb is set:
   - After all stages complete successfully
   - Print sync results in summary section

Key patterns from existing push-kb command:
- Set git config http.postBuffer 524288000 before push (large repos)
- Exclude .DS_Store files in rsync
- Check if there are changes before committing (git diff --staged --quiet)

For source directories, use this priority:
- If run_dir outputs exist (e.g., run_dir/converted/), use those
- Else fall back to root directories (converted/, indexes/, prompts/)
  </action>
  <verify>python pipeline.py --help shows --push-kb option</verify>
  <done>--push-kb argument added, sync_to_kb() function implemented</done>
</task>

<task type="auto">
  <name>Task 2: Test sync function with dry-run option</name>
  <files>pipeline.py</files>
  <action>
Add --dry-run support to sync_to_kb():

1. Add --dry-run argument to parse_args():
   ```python
   parser.add_argument(
       "--dry-run",
       action="store_true",
       help="Show what would be synced without actually pushing (use with --push-kb)"
   )
   ```

2. Modify sync_to_kb(dry_run: bool = False) to:
   - When dry_run=True: do everything except git push
   - Print what files would be synced
   - Print what commit message would be used
   - Skip the actual push

3. Test the sync flow by running:
   ```bash
   python pipeline.py --skip-scrape --skip-ai --push-kb --dry-run
   ```

   This should:
   - Clone/update the bobot-kb repo
   - Rsync the directories
   - Show what would be committed
   - NOT push to GitHub
  </action>
  <verify>python pipeline.py --skip-scrape --skip-ai --push-kb --dry-run completes without errors and shows sync preview</verify>
  <done>--dry-run flag works, sync preview shows files and commit message</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] python pipeline.py --help shows --push-kb and --dry-run options
- [ ] python pipeline.py --skip-scrape --skip-ai --push-kb --dry-run shows sync preview
- [ ] No Python errors or exceptions
- [ ] Code follows existing pipeline.py patterns
</verification>

<success_criteria>

- --push-kb flag added to pipeline.py
- sync_to_kb() function syncs converted/, indexes/, prompts/ to GitHub
- --dry-run allows testing without pushing
- Function handles both run directory and root directory sources
  </success_criteria>

<output>
After completion, create `.planning/phases/26-kb-sync-integration/26-01-SUMMARY.md`
</output>
