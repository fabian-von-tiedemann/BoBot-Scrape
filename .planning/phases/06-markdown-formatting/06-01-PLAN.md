---
phase: 06-markdown-formatting
plan: 01
type: execute
depends_on: []
files_modified: [src/formatters/__init__.py, src/formatters/markdown.py]
---

<objective>
Convert extracted text to well-structured Markdown with proper headings, lists, and tables.

Purpose: Transform raw text output from Phase 5 extractors into readable Markdown format suitable for RAG/GraphRAG consumption in Phase 7-8.
Output: src/formatters module with text_to_markdown() function that structures raw text into Markdown.
</objective>

<execution_context>
./.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-text-extraction/05-01-SUMMARY.md
@src/extractors/__init__.py
@src/extractors/pdf.py
@src/extractors/word.py

**Tech stack available:** pymupdf, python-docx
**Established patterns:** File-type dispatch, graceful-error-handling, modular extractors
**Key constraint:** Output from extract_text() is plain text with implicit structure (section names, bullet points, pipe-separated tables)

**Input characteristics (from sample analysis):**
- Swedish rutindokument from Botkyrka kommun
- Headers: Section names like "Inledning", "Roller och ansvar", "Utförande", "RUTIN [Name]"
- Document metadata block at top (Beslutat av, Beslutades den, Gäller till, etc.)
- Lists: Lines starting with bullet points (•, -, *)
- Tables from Word: Pipe-separated cells from extract_word()
- Numbered items: "1.", "2.", etc.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatters module with text_to_markdown()</name>
  <files>src/formatters/__init__.py, src/formatters/markdown.py</files>
  <action>
Create src/formatters/ module following extractors pattern:

**src/formatters/__init__.py:**
- Export text_to_markdown(text: str) -> str
- Import from .markdown

**src/formatters/markdown.py:**
- format_to_markdown(text: str) -> str main function
- Detect and format Swedish rutindokument structure:

**Header detection patterns (convert to ## headers):**
- ALL CAPS lines that are section names (e.g., "RUTIN", "INLEDNING") -> # or ##
- Lines ending with colon that start paragraphs -> ##
- Common section names: "Inledning", "Roller och ansvar", "Område", "Utförande", "Definitioner", "Syfte"
- Document title pattern "RUTIN [Name]" -> # heading

**Metadata block (first ~10 lines typically):**
- Lines matching "Dokumentet är beslutat av:", "Dokumentet beslutades den:", etc.
- Keep as-is but add --- separator after metadata block

**List detection:**
- Lines starting with "•", "-", "*" -> Markdown bullet points "- "
- Lines starting with numbers and period (1., 2.) -> Keep as numbered list

**Table handling:**
- Lines with " | " separators (from Word extraction) -> Markdown table format
- Detect consecutive pipe-separated lines as table rows
- Add header separator row after first table row

**Whitespace normalization:**
- Multiple blank lines -> single blank line
- Trim trailing whitespace

DO NOT over-engineer: Simple regex patterns, no NLP/ML. These are structured bureaucratic documents with consistent patterns.
  </action>
  <verify>.venv/bin/python -c "from src.formatters import text_to_markdown; print('Import OK')"</verify>
  <done>Module imports successfully, text_to_markdown() function exists</done>
</task>

<task type="auto">
  <name>Task 2: Test markdown formatter on real documents</name>
  <files>src/formatters/markdown.py</files>
  <action>
Test the formatter end-to-end with real extracted documents:

```python
from src.extractors import extract_text
from src.formatters import text_to_markdown

# Test with PDF
pdf_path = "downloads/Ledsagning, Avlösning och Kontaktperson/Bemanning%20och%20vikarieanskaffning%20kla.pdf"
raw = extract_text(pdf_path)
md = text_to_markdown(raw)
print(md)
```

Verify output shows:
1. Document title as # heading
2. Metadata block preserved (possibly with --- separator)
3. Section names as ## headings
4. Bullet points properly formatted
5. Clean whitespace

Fix any issues found during testing. The formatter should produce readable Markdown that could be rendered or used in RAG systems.

Edge cases to handle:
- Empty or None input -> return empty string
- Text with no detectable structure -> return original text (passthrough)
- Very short text -> don't over-format
  </action>
  <verify>.venv/bin/python -c "
from src.extractors import extract_text
from src.formatters import text_to_markdown
import os
# Test on first PDF found
for root, dirs, files in os.walk('downloads'):
    for f in files:
        if f.endswith('.pdf'):
            path = os.path.join(root, f)
            raw = extract_text(path)
            if raw:
                md = text_to_markdown(raw)
                # Check it has markdown headers
                has_headers = '# ' in md or '## ' in md
                print(f'Headers detected: {has_headers}')
                print(f'Length: {len(md)} chars')
                print(md[:500])
            break
    break
"</verify>
  <done>Formatter produces readable Markdown with headers/structure from real PDF, handles edge cases gracefully</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `from src.formatters import text_to_markdown` imports successfully
- [ ] Formatter converts raw text to structured Markdown
- [ ] Headers detected and formatted (# or ##)
- [ ] Lists formatted as Markdown lists
- [ ] Empty/None input handled gracefully
- [ ] Real PDF and DOCX documents format correctly
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- text_to_markdown() produces readable Markdown from extracted text
- Structure preserved: headers, lists, tables
- Phase 6 complete, ready for Phase 7 (Metadata & AI)
</success_criteria>

<output>
After completion, create `.planning/phases/06-markdown-formatting/06-01-SUMMARY.md`:

# Phase 6 Plan 01: Markdown Formatting Summary

**[One-liner about what was built]**

## Performance
- **Duration:** X min
- **Tasks:** 2
- **Files modified:** N

## Accomplishments
- [Key outcomes]

## Task Commits
1. **Task 1:** commit-hash (type)
2. **Task 2:** commit-hash (type)

## Files Created/Modified
- `src/formatters/__init__.py` - Module entry point
- `src/formatters/markdown.py` - Markdown conversion logic

## Decisions Made
[Any decisions about formatting rules]

## Issues Encountered
[Problems and resolutions]

## Next Phase Readiness
- Markdown formatter ready
- Phase 7 (Metadata & AI) can add frontmatter to formatted documents
</output>
