---
phase: 31-export-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/qa/exporter.py
  - src/qa/__init__.py
  - generate_qa.py
autonomous: true

must_haves:
  truths:
    - "HuggingFace datasets can load output with load_dataset('json', data_files=...)"
    - "Each exported QA pair has question, answer, source fields in English"
    - "Metadata (persona, validation_score) is included in flat structure"
    - "CLI --export mode transforms validated JSONL to HuggingFace format"
  artifacts:
    - path: "src/qa/exporter.py"
      provides: "HuggingFace export logic"
      exports: ["transform_to_hf", "export_hf_jsonl"]
      min_lines: 50
    - path: "qa/qa_pairs.jsonl"
      provides: "HuggingFace-compatible passed pairs"
      format: "flat JSONL with English field names"
    - path: "qa/qa_rejected_hf.jsonl"
      provides: "HuggingFace-compatible rejected pairs"
      format: "flat JSONL with English field names"
  key_links:
    - from: "generate_qa.py"
      to: "src/qa/exporter.py"
      via: "import export_hf_jsonl"
      pattern: "from src.qa import.*export"
    - from: "src/qa/exporter.py"
      to: "qa/qa_passed.jsonl"
      via: "reads validated JSONL"
      pattern: "json.loads.*line"
---

<objective>
Create HuggingFace-compatible JSONL export from validated QA pairs.

Purpose: Transform internal validation output (Swedish field names, nested objects) to flat JSONL format that works directly with `datasets.load_dataset('json', data_files=...)`. This enables using the QA pairs for AI training without format conversion.

Output:
- src/qa/exporter.py module with transform and export functions
- --export CLI mode in generate_qa.py
- qa_pairs.jsonl (passed) and qa_rejected_hf.jsonl (rejected) in HuggingFace format
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-export-integration/31-RESEARCH.md
@.planning/phases/31-export-integration/31-CONTEXT.md

# Existing code
@src/qa/validator.py
@src/qa/__init__.py
@generate_qa.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HuggingFace export module</name>
  <files>src/qa/exporter.py, src/qa/__init__.py</files>
  <action>
Create src/qa/exporter.py with HuggingFace export logic:

1. `transform_to_hf(entry: dict) -> dict` function:
   - Input: validated QA entry from qa_passed.jsonl (has nested validation object)
   - Output: flat dict with English field names:
     ```python
     {
         "question": entry["question"],
         "answer": entry["answer"],
         "source": entry.get("source_document", ""),
         "persona": f"{entry['persona']['roll']}/{entry['persona']['erfarenhet']}",
         "validation_score": entry["validation"]["composite_score"],
     }
     ```
   - Handle missing fields gracefully with defaults

2. `read_jsonl_streaming(path: Path)` generator:
   - Stream JSONL entries without loading entire file
   - Use `encoding='utf-8'` for Swedish characters
   - Skip empty lines

3. `export_hf_jsonl(input_path: Path, output_path: Path, include_rejected: bool = False) -> dict` function:
   - Read from input JSONL (streaming)
   - Transform each entry with transform_to_hf
   - Write to output using `json.dumps(entry, ensure_ascii=False)`
   - Return stats dict: {"total": N, "exported": N}
   - For rejected pairs: include validation.failure_reason in output

4. Update src/qa/__init__.py:
   - Add exports: transform_to_hf, export_hf_jsonl, read_jsonl_streaming
   - Add to __all__ list

IMPORTANT: Use `ensure_ascii=False` in all json.dumps calls to preserve Swedish characters (a, o, a).
  </action>
  <verify>
```bash
# Check module exists and has exports
python3 -c "from src.qa import transform_to_hf, export_hf_jsonl; print('Imports OK')"
```
  </verify>
  <done>
- exporter.py exists with transform_to_hf, read_jsonl_streaming, export_hf_jsonl functions
- __init__.py updated with new exports
- All functions handle UTF-8 encoding correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --export mode to CLI</name>
  <files>generate_qa.py</files>
  <action>
Add --export mode to generate_qa.py CLI:

1. Add argument to parse_args():
   ```python
   parser.add_argument(
       "--export",
       action="store_true",
       help="Export validated QA pairs to HuggingFace-compatible JSONL format"
   )
   ```

2. Create export_command(args) function:
   - Check qa_passed.jsonl exists (error if not, suggest --validate first)
   - Import export_hf_jsonl from src.qa
   - Export passed pairs: qa/qa_passed.jsonl -> qa/qa_pairs.jsonl
   - Export rejected pairs: qa/qa_rejected.jsonl -> qa/qa_rejected_hf.jsonl
   - Print summary:
     ```
     === Export Summary ===
     Passed pairs: N -> qa/qa_pairs.jsonl
     Rejected pairs: N -> qa/qa_rejected_hf.jsonl

     HuggingFace usage:
       from datasets import load_dataset
       dataset = load_dataset('json', data_files='qa/qa_pairs.jsonl')
     ```

3. Add to main() dispatch:
   ```python
   if args.export:
       return export_command(args)
   ```
   Place after --validate check

4. Update epilog examples to include --export

IMPORTANT: Follow existing CLI patterns from --validate and --answers modes.
  </action>
  <verify>
```bash
# Test CLI help shows --export
python3 generate_qa.py --help | grep -A2 "export"

# Run export (requires existing qa_passed.jsonl)
python3 generate_qa.py --export

# Verify output format is HuggingFace-compatible
head -1 qa/qa_pairs.jsonl | python3 -c "import json,sys; d=json.load(sys.stdin); print('Fields:', list(d.keys()))"
```
  </verify>
  <done>
- --export flag added to CLI
- export_command function implements export logic
- qa_pairs.jsonl created with flat HuggingFace format
- qa_rejected_hf.jsonl created for rejected pairs
- Output has English field names: question, answer, source, persona, validation_score
  </done>
</task>

</tasks>

<verification>
```bash
# 1. Verify module imports
python3 -c "from src.qa import transform_to_hf, export_hf_jsonl; print('Module OK')"

# 2. Run export
python3 generate_qa.py --export

# 3. Verify HuggingFace compatibility
python3 -c "
from datasets import load_dataset
ds = load_dataset('json', data_files='qa/qa_pairs.jsonl')
print(f'Loaded {len(ds[\"train\"])} examples')
print('Fields:', ds['train'].features)
print('Sample:', ds['train'][0])
"

# 4. Verify Swedish characters preserved
head -1 qa/qa_pairs.jsonl | grep -v '\\u00'  # Should show actual Swedish chars, not escapes
```
</verification>

<success_criteria>
- [ ] src/qa/exporter.py exists with transform_to_hf, export_hf_jsonl functions
- [ ] generate_qa.py --export mode works
- [ ] qa/qa_pairs.jsonl created with flat structure and English field names
- [ ] qa/qa_rejected_hf.jsonl created for rejected pairs
- [ ] `datasets.load_dataset('json', data_files='qa/qa_pairs.jsonl')` loads without error
- [ ] Swedish characters preserved (not escaped as \u00xx)
</success_criteria>

<output>
After completion, create `.planning/phases/31-export-integration/31-01-SUMMARY.md`
</output>
