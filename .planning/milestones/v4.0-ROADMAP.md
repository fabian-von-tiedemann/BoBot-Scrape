# Milestone v4.0: Pipeline Refactor

**Status:** ✅ SHIPPED 2026-01-16
**Phases:** 24-26
**Total Plans:** 3

## Overview

Generalisera ETL-flödet till en versionshanterbar pipeline med timestampade output-mappar och stöd för inkrementella uppdateringar.

## Phases

### Phase 24: Pipeline Runner

**Goal**: Unified CLI that orchestrates all stages (scrape, convert, index, prompts) with timestamped output directories
**Depends on**: Phase 23 (Parallel AI Calls)
**Plans**: 1 plan

Plans:

- [x] 24-01: Create pipeline.py CLI with timestamped run directories — completed 2026-01-16

**Details:**
- Created pipeline.py CLI with --run-dir, --skip-scrape, --skip-ai, --force options
- Implemented timestamped run directory structure (runs/YYYY-MM-DD-HHMM/)
- All 5 stages execute in sequence with correct path passing
- Used sys.executable for subprocess calls to ensure correct Python interpreter

### Phase 25: Incremental Updates

**Goal**: Detect new/changed documents and process only those (skip already-processed files)
**Depends on**: Phase 24
**Plans**: 1 plan

Plans:

- [x] 25-01: Implement manifest-based diff detection and incremental convert — completed 2026-01-16

**Details:**
- Implemented manifest.json file tracking document URLs and MD5 hashes per run
- Added --prev-run CLI argument for comparing against previous runs
- Diff detection identifies new, changed, removed, and unchanged documents
- Convert stage uses --include-files to process only changed documents
- Pipeline correctly skips convert stage when no changes detected

### Phase 26: KB Sync Integration

**Goal**: Automatic push to bobot-kb repo after pipeline run completes
**Depends on**: Phase 25
**Plans**: 1 plan

Plans:

- [x] 26-01: Add --push-kb flag and sync_to_kb() function — completed 2026-01-16

**Details:**
- Added --push-kb argument to push KB content to bobot-kb GitHub repo after pipeline completes
- Implemented sync_to_kb() function that clones/updates repo, rsyncs directories, and pushes
- Added --dry-run argument for previewing sync without actually pushing
- Function handles both run directory and root directory sources with fallback logic

---

## Milestone Summary

**Key Decisions:**

- Use sys.executable instead of 'python' for subprocess calls
- Run directory structure: runs/YYYY-MM-DD-HHMM/{downloads,converted,indexes,prompts}
- Use MD5 hash for URL comparison (fast, deterministic)
- Store diff results in manifest.json for traceability
- Skip convert stage entirely when no changes detected
- Use standard git CLI instead of gh CLI (may not be installed)
- Sync to /tmp/bobot-kb-sync temp directory for clean operations
- Don't exit with error if sync fails - pipeline completed successfully

**Issues Resolved:**

- Fixed Python interpreter resolution for subprocess calls
- Fixed datetime.utcnow() deprecation warning (Python 3.12+)
- Fixed UTF-8 encoding error in rsync output with Swedish filenames

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- When convert stage is skipped (no changes), subsequent stages may fail because converted/ directory doesn't exist in new run. In a real incremental workflow, unchanged outputs would be copied from previous run.

---

_For current project status, see .planning/ROADMAP.md_
